<div data-role="page" data-theme="b" id="bmiAddPage">
    <div data-role="header">
        <a href="#ajax/bmi/list.html" data-icon="back">Back</a>
        <h1>Add BMI log</h1>
    </div>
    <div data-role="content">
        <form id="bmiForm" name="bmiForm">
            <div data-role="fieldcontain">
                <label for="user">
                    User:
                </label>
                <select name="user" id="user">
                </select>
            </div>
            <div data-role="fieldcontain">
                <label for="weight">
                    Weight(kg):
                </label>
                <input type="number" name="weight" id="weight" value="" />
            </div>
            <button type="submit" name="submit">
                Submit
            </button>
        </form>
    </div>
    <div data-role="footer">
        <h4><a href="http://olc.tw/">olc.tw</a></h4>
    </div>
    <script type="text/javascript" charset="utf-8">
        $(function(){
            $('form#bmiForm').submit(function(){
                /*
                 * Get user's height first
                 */
                var user = $('#user').val();
                var height;
                db.transaction(function(tx){
                    tx.executeSql('SELECT height FROM user WHERE user = ?', [user], function(tx, results){
                        height = results.rows.item(0).height;
                        var weight = $('#weight').val();
                        var bmi = weight / ((height / 100) ^2);
                        bmi = Math.round(bmi * 100) / 100;
                        var data = [user, weight, bmi];
                        tx.executeSql('INSERT INTO bmi (user, weight, bmi, created) VALUES (?, ?, ?, datetime(\'now\', \'localtime\'))', data, function(){
                            $.mobile.changePage($('#bmiListPage'), 'slide', true, true);
                        });
                    });
                });
                return false;
            });
            $('div#bmiAddPage').live('pageshow', function(){
                db.transaction(function(tx){
                    tx.executeSql('SELECT user FROM user ORDER BY id ASC', [], function(tx, results){
                        var userHtml = '';
                        var currentUser;
                        for (var i = 0; i < results.rows.length; i++) {
                            currentUser = results.rows.item(i).user;
                            userHtml += '<option value="' + currentUser + '">' + currentUser + '</option>';
                        }
                        $('select#user').html(userHtml);
                    });
                }, dbError);
            });
        })
    </script>
</div>
